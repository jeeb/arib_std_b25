【名称】

　ARIB STD-B25 仕様確認テストプログラムソースコード

【バージョン】

　0.1.4

【作者】

　茂木 和洋 (MOGI, Kazuhiro) 
　kazhiro@marumo.ne.jp

【一次配布元】

　http://www.marumo.ne.jp/db2008_2.htm#02

　あるいは

　http://www.marumo.ne.jp/junk/arib_std_b25-0.1.4.lzh

【目的】

　ARIB STD-B25 の仕様を理解する為の、参考用の実装として公開

【背景】

　2011 年 7 月の地上アナログ放送停波を控え、廉価な地上デジタル放送
　受信機の販売が待たれている

　しかし、ARIB の標準文書はわざと判りにくく書いて開発費をかさませ
　ようとしているとしか思えないほどに意味不明瞭な記述になっており
　このままでは低価格受信機の開発など不可能に思える

　そこで、自分なりに ARIB 標準文書を読み、理解した範囲をソース
　コードの形にまとめて公開することにした

　このコードが安価な受信機の開発の一助となることを期待する

　なお、あくまでも仕様理解を目的としたものであるため、ビルド済み
　バイナリファイルは配布しない

【実装した範囲】

　CA システム (B-CAS カード関連) を中心に ECM の処理とストリーム
　暗号の復号処理までを実装した

　EMM 関連は未実装となっている

【プログラムの動作環境】

　ISO 7816 対応の IC カードリーダがインストールされた Windows PC を
　想定動作環境とする

　ISO 7816 対応スマートカードリーダーは一般に
　「住基カード対応 IC カードリーダ」「e-Tax 対応 IC カードリーダ」
　などとして 4000 円程度で販売されているものが利用可能である

　日立マクセル製の HX-520UJJ で正常に動作することを確認している

【プログラムの構成】

　・arib_std_b25.h/c

　　ARIB STD-B25 記載の処理を行うためのモジュール
　　MPEG-2 TS の分離、CA システム (B-CAS カード) 機能の呼び出し、
　　MULTI2 復号機能の呼び出し等を担当する

　・b_cas_card.h/c

　　CA システム (B-CAS カード) のリソース管理および直接の制御を
　　担当する

　・multi2.h/c

　　MULTI2 暗号の符号化と復号を担当する

　・td.c

　　テストドライバ
　　PAT/PMT/ECM を含む MPEG-2 TS ファイルを読み込み、復号後の
　　MPEG-2 TS ファイルを出力する

　　コマンドラインオプションで MULTI2 暗号のラウンド数を指定可能
　　ラウンド数を指定しない場合の初期値は 4

　　このラウンド数 4 は MULTI2 用語では 32 に相当する

　　ARIB STD-B25 では MULTI2 のラウンド数は非公開パラメータだが
　　総当たりで実際のラウンド数は推定可能である

【処理の流れ】

　・起動時

　　1 アプリケーションは B_CAS_CARD モジュールのインスタンスを
　　　作成し、B_CAS_CARD モジュールに、初期化を依頼する

　　1.a B_CAS_CARD モジュールは WIN32 API のスマートカード関連
　　　　API を呼び出し、CA システムに接続する
　　1.b B_CAS_CARD モジュールは ARIB STD-B25 記載の「初期条件
　　　　設定コマンドを CA システムに発行し、システム鍵 (64 byte)
　　　　初期 CBC 状態 (8 byte) を受け取る 

　　2 アプリケーションは ARIB_STD_B25 モジュールのインスタンスを
　　　作成し、B_CAS_CARD モジュールを ARIB_STD_B25 モジュールに
　　　登録する

　・データ処理時

　　1 アプリケーションは ARIB_STD_B25 モジュールに順次データを
　　　提供し、ARIB_STD_B25 モジュールから処理完了データを受け
　　　取ってファイルに出力していく

　　・ARIB_STD_B25 モジュール内

　　　1 TS パケットのユニットサイズ (188/192/204 などが一般的) が
　　　　特定されていない場合 8K まで入力データをバッファしてから、
　　　　ユニットサイズを特定する
　　　　ユニットサイズが特定できなかった場合は、エラー終了する

　　　2 PAT が発見されていない場合、PAT が発見できるまで入力
　　　　データをバッファし続ける
　　　　PAT が発見できずにバッファサイズが 16M を超過した場合
　　　　エラー終了する
　　　　PAT が発見できた場合、プログラム配列を作成し PID マップ
　　　　配列に登録する

　　　3 PAT に登録されていた PMT すべてが発見されるか、どれか
　　　　ひとつの PMT で 2 個目のセクションが到着するまで入力
　　　　データをバッファし続ける
　　　　上記条件を満たさずにバッファサイズが 32M を超過した場合
　　　　エラー終了する
　　　　PMT が到着する毎に ECM の有無を確認し、ECM が存在する
　　　　場合はデクリプタを作成してプログラムに所属するストリーム
　　　　と PID マップ上で関連付ける

　　　4 PMT に登録されていた ECM すべてが発見されるか、どれか
　　　　ひとつの ECM で 2 個目のセクションが到着するまで入力
　　　　データをバッファし続ける
　　　　上記条件を満たさずにバッファサイズが 32M を超過した場合
　　　　エラー終了する
　　　　各 ECM に対して、最初のセクションデータが到着した時点で
　　　　MULTI2 モジュールのインスタンスをデクリプタ上に作成する
　　　　ECM セクションデータは B_CAS_CARD モジュールに提供して
　　　　スクランブル鍵を受け取り、MULTi2 モジュールにシステム鍵、
　　　　初期 CBC 状態、スクランブル鍵を渡し、MULTI2 復号の準備を
　　　　行う

　　　5.a 暗号化されている TS パケットであれば、PID から
　　　　　対応プログラムを探し、MULTI2 モジュールに復号させて
　　　　　出力バッファに積む
　　　　
　　　5.b 暗号化されていない TS パケットであれば、そのまま
　　　　　出力バッファに積む

　　　6 ECM が更新された場合、B_CAS_CARD モジュールに処理を
　　　　依頼し、出力されたスクランブル鍵を MULTI2 モジュールに
　　　　登録する

　　　7 PMT が更新された場合、ECM PID が変化していれば新たに
　　　　デクリプタを作成して 4 に戻る

　　　8 PAT が更新された場合、プログラム配列を破棄して
　　　　3 に戻る

　・終了時

　　1 各モジュールが確保したリソースを解放する

【更新履歴】

　・2008, 2/2 - ver. 0.1.4

　　ver. 0.1.3 での PMT 処理方法変更に問題があり、PMT が更新された
　　場合、それ以降で正常な処理が行えなくなっていたバグを修正

　　B-CAS カードとの通信でエラーが発生した場合のリトライ処理が機能
　　していなかったバグを修正

　　http://www.marumo.ne.jp/db2008_2.htm#2 又は
　　http://www.marumo.ne.jp/junk/arib_std_b25-0.1.4.lzh

　・2008, 2/1 - ver. 0.1.3

　　有料放送等で未契約状態の B-CAS カードを使った際に、鍵が取得で
　　きていないにもかかわらず、間違った鍵で復号をしていた問題に対処

　　鍵が取得できなかった ECM に関連付けられたストリームでは復号を
　　行わず、スクランブルフラグを残したまま入力を素通しする形に変更
　　鍵が取得できない ECM が存在する場合、終了時にチャネル番号と
　　B-CAS カードから取得できたエラー番号を警告メッセージとして表示
　　する形に変更

　　暗号化されていないプログラムで例外を発生させていたバグを修正

　　http://www.marumo.ne.jp/db2008_2.htm#1 又は
　　http://www.marumo.ne.jp/junk/arib_std_b25-0.1.3.lzh

　・2008, 1/11 - ver. 0.1.2

　　デジタル BS 放送等で、PAT に登録されているのに、ストリーム内で
　　PMT が一切出現しないことがある場合に対応

　　PMT 内の記述子領域 2 に CA_descriptor が存在する場合に対応する
　　ため arib_std_b25.c 内部での処理構造を変更

　　別プログラムと同時実行するためにスマートカードの排他制御指定を
　　変更

　　http://www.marumo.ne.jp/db2008_1.htm#11 又は
　　http://www.marumo.ne.jp/junk/arib_std_b25-0.1.2.lzh

　・2008, 1/7 - ver. 0.1.1

　　セクション (PAT/PMT/ECM 等) が複数の TS パケットに分割されている
　　場合に、正常に処理できなかったり、例外を発生をさせることがある
　　バグを修正

　　http://www.marumo.ne.jp/db2008_1.htm#7 又は
　　http://www.marumo.ne.jp/junk/arib_std_b25-0.1.1.lzh

　・2007, 11/25 - ver. 0.1.0

　　公開

　　http://www.marumo.ne.jp/db2007_b.htm#25 又は
　　http://www.marumo.ne.jp/junk/arib_std_b25-0.1.0.lzh

